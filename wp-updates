#!/bin/bash
LOG_FILE="wp-updates.log"
exec > >(tee -a "$LOG_FILE") 2>&1

WP="${HOME}/yps.tools/wp --path=${HOME}/public_html"
EXCLUDE=(woocommerce-product-stock-alert tiktok-for-woocommerce)

# Get plugins that need updating (filtering out excluded ones)
plugins=$($WP plugin list --field=name)
for plugin in $plugins; do
  if [[ ! " ${EXCLUDE[*]} " =~ " ${plugin} " ]]; then
    PLUGINS_TO_UPDATE+=("$plugin")
  fi
done

# Inline function for updating with logging and error handling
update() {
  echo "üîÑ $1"
  shift
  "$@" || { echo "‚ùå Error: '$1' update failed."; exit 1; }
}

update "WordPress Core" $WP core update
update "Themes" $WP theme update --all

for p in "${PLUGINS_TO_UPDATE[@]}"; do
  update "Plugin ${p}" $WP plugin update "${p}"
done

update "Database" $WP core update-db
update "WooCommerce" $WP wc update
